module.exports=function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=17)}([function(e,t){e.exports=require("lodash/isUndefined")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("node-pty")},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("serve-favicon")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("express-winston")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("yargs")},,,function(e,t,n){"use strict";n.r(t);var s=n(0),r=n.n(s),o=n(6),i=n(4),c=n(7),a=n(8),l=n(9),u=n(10),p=n(1),d=n(11),h=n(12),f=(e,t)=>(n,s)=>{const r=/^\/ssh\//.test(n.url.replace(e,"/"))?"../":e;s.send(`<!doctype html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">\n    <title>${t}</title>\n    <link rel="stylesheet" href="${r}public/index.css" />\n  </head>\n  <body>\n    <div id="overlay">\n      <div class="error">\n        <div id="msg"></div>\n        <input type="button" onclick="location.reload();" value="reconnect" />\n      </div>\n    </div>\n    <div id="options">\n      <a class="toggler"\n         href="#"\n         alt="Toggle options"><i class="fas fa-cogs"></i></a>\n      <textarea class="editor"></textarea>\n    </div>\n    <div id="terminal"></div>\n    <script src="${r}public/index.js"><\/script>\n  </body>\n</html>`)},m=n(3);const{combine:v,timestamp:b,label:y,simple:g,json:x,colorize:w}=m.format;var k=Object(m.createLogger)({format:v(w({all:!1}),y({label:"Wetty"}),b(),x()),transports:[new m.transports.Console({level:"info",handleExceptions:!0})]});const $=p.join(__dirname,"client"),j=e=>e.replace(/\/*$/,"");var q=n(13);function O(e,t,n){const s=e.match(".+/ssh/([^/]+)$"),r=t?`${t}@${n}`:n;return s?`${s[1].split("?")[0]}@${n}`:r}const S=e=>r()(e.split(":")[3])?"localhost":e.split(":")[3];function P(e,t){return"login"===e?[e,"-h",S(t)]:[e]}function _({pass:e,path:t,command:n,host:s,port:o,auth:i,knownhosts:c},a){const l=function(e,t){return"login"===e&&r()(t)?"":r()(t)?e:`$SHELL -c "cd ${t};${"login"===e?"$SHELL":e}"`}(n,t),u=["ssh",s,"-t","-p",o,"-o",`PreferredAuthentications=${i}`,"-o",`UserKnownHostsFile=${c}`,"-o",`StrictHostKeyChecking=${"/dev/null"!==c?"yes":"no"}`];return k.info(`Authentication Type: ${i}`),r()(a)?""!==e?["sshpass","-p",e].concat(u,[l]):("none"===i&&u.splice(u.indexOf("-o"),2),""===l?u:u.concat([l])):u.concat(["-i",a,l])}const T=e=>0===process.getuid()&&("localhost"===e||"0.0.0.0"===e||"127.0.0.1"===e),L=(e,t)=>Object.assign(t,q.parse(e,!0).query);var A=({request:{headers:{referer:e}},client:{conn:{remoteAddress:t}}},{user:n,host:s,port:r,auth:o,pass:i,key:c,knownhosts:a},l,u)=>({args:!u&&T(s)?P(l,t):_({...L(e,{port:`${r}`,pass:i||"",command:l,auth:o,knownhosts:a}),host:O(e,n,s)},c),user:!u&&T(s)||""!==n||n.includes("@")||O(e,n,s).includes("@")}),C=n(2),H=n(5);const z={name:"xterm-256color",cols:80,rows:30,cwd:process.cwd(),env:Object.assign({},...Object.keys(process.env).filter(e=>!r()(process.env[e])).map(e=>({[e]:process.env[e]})))};function E(e,t){const n=Object(C.spawn)("/usr/bin/env",t,z),{pid:s}=n,o="ssh"===t[0]?t[1]:"localhost";k.info("Process Started on behalf of user",{pid:s,address:o}),e.emit("login"),n.on("exit",t=>{k.info("Process exited",{code:t,pid:s}),e.emit("logout"),e.removeAllListeners("disconnect").removeAllListeners("resize").removeAllListeners("input")}),n.on("data",t=>{e.emit("data",t)}),e.on("resize",({cols:e,rows:t})=>{n.resize(e,t)}).on("input",e=>{r()(n)||n.write(e)}).on("disconnect",()=>{n.kill(),k.info("Process exited",{code:0,pid:s})})}function F(e={user:"",host:"localhost",auth:"password",port:22},t={base:"/wetty/",port:3e3,host:"0.0.0.0",title:"WeTTy",bypasshelmet:!1},n="",s=!1,m){return async function(e){if(r()(e)||r()(e.key)||r()(e.cert))return{};const[t,n]=await Promise.all([Object(H.readFile)(Object(p.resolve)(e.key)),Object(H.readFile)(Object(p.resolve)(e.cert))]);return{key:t,cert:n}}(m).then(m=>{e.key&&k.warn(`!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n! Password-less auth enabled using private key from ${e.key}.\n! This is dangerous, anything that reaches the wetty server\n! will be able to run remote operations without authentication.\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!`);const v=function({base:e,port:t,host:n,title:s,bypasshelmet:m},{key:v,cert:b}){const y=j(e);k.info("Starting server",{key:v,cert:b,port:t,base:e,title:s});const g=i();g.use(h.logger(k)).use(o()).use(c(p.join($,"favicon.ico"))).use(`${y}/public`,i.static($)).use((e,t,n)=>{"/"===e.path.substr(-1)&&e.path.length>1?t.redirect(301,e.path.slice(0,-1)+e.url.slice(e.path.length)):n()}),m||g.use(a());const x=f(e,s);return g.get(y,x).get(`${y}/ssh/:user?`,x),d(r()(v)||r()(b)?l.createServer(g).listen(t,n,()=>{k.info("Server started",{port:t,connection:"http"})}):u.createServer({key:v,cert:b},g).listen(t,n,()=>{k.info("Server started",{port:t,connection:"https"})}),{path:`${y}/socket.io`,pingInterval:3e3,pingTimeout:7e3})}(t,m);return v.on("connection",t=>{k.info("Connection accepted.");const{args:r,user:o}=A(t,e,n,s);k.debug("Command Generated",{user:o,cmd:r.join(" ")}),o?E(t,r):function(e){const t=e.request.headers["remote-user"];if(t)return new Promise(e=>{e(t)});const n=Object(C.spawn)("/usr/bin/env",["node",`${__dirname}/buffer.js`],z);let s="";return new Promise((t,r)=>{n.on("exit",()=>{t(s)}),n.on("data",t=>{e.emit("data",t)}),e.on("input",e=>{n.write(e),s=/\177/.exec(e)?s.slice(0,-1):s+e}).on("disconnect",()=>{n.kill(),r()})})}(t).then(e=>(r[1]=`${e.trim()}@${r[1]}`,k.debug("Spawning term",{username:e.trim(),cmd:r.join(" ").trim()}),E(t,r))).catch(()=>{k.info("Disconnect signal sent")})}),v})}var M=n(14);t.default={start:F,init:function(e){if(e.help)M.showHelp(),process.exitCode=0;else{const{ssh:n,server:s,command:o,forcessh:i,ssl:c}={ssh:{user:(t=e).sshuser,host:t.sshhost,auth:t.sshauth,port:t.sshport,pass:t.sshpass,key:t.sshkey,knownhosts:t.knownhosts},server:{base:t.base,host:t.host,port:t.port,title:t.title,bypasshelmet:t.bypasshelmet||!1},command:t.command,forcessh:t.forcessh,ssl:r()(t.sslkey)||r()(t.sslcert)?void 0:{key:t.sslkey,cert:t.sslcert}};F(n,s,o,i,c).catch(e=>{k.error(e),process.exitCode=1})}var t}}}]);
//# sourceMappingURL=index.js.map